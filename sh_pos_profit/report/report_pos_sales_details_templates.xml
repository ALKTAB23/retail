<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Safer approach: Create a completely new template instead of inheriting problematic one -->
    <template id="report_pos_sales_details_profit" name="POS Sales Details with Profit">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <div class="page">
                    <h2>Sales Details with Profit Analysis</h2>
                    <div class="row">
                        <div class="col-12">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Quantity</th>
                                        <th>Price Unit</th>
                                        <th>Subtotal</th>
                                        <th>Discount</th>
                                        <th>Cost Price</th>
                                        <th>Cost Subtotal</th>
                                        <th>Profit</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-set="subtotal_total" t-value="0.0" />
                                    <t t-set="cost_subtotal_total" t-value="0.0" />
                                    <t t-set="profit_total" t-value="0.0" />
                                    <t t-set="discount_total" t-value="0.0" />
                                    
                                    <t t-foreach="lines or []" t-as="line">
                                        <t t-set="line_subtotal" t-value="line.get('quantity', 0) * line.get('price_unit', 0)" />
                                        <t t-set="line_discount" t-value="(line_subtotal * line.get('discount', 0)) / 100" />
                                        <t t-set="line_cost_subtotal" t-value="line.get('cost_price', 0) * line.get('quantity', 0)" />
                                        <t t-set="line_profit" t-value="line_subtotal - line_cost_subtotal" />
                                        
                                        <tr>
                                            <td><span t-esc="line.get('product_name', 'Unknown Product')" /></td>
                                            <td><span t-esc="line.get('quantity', 0)" /></td>
                                            <td><span t-esc="'%.2f' % line.get('price_unit', 0)" /></td>
                                            <td><span t-esc="'%.2f' % line_subtotal" /></td>
                                            <td><span t-esc="'%.2f' % line_discount" /></td>
                                            <td><span t-esc="'%.2f' % line.get('cost_price', 0)" /></td>
                                            <td><span t-esc="'%.2f' % line_cost_subtotal" /></td>
                                            <td><span t-esc="'%.2f' % line_profit" /></td>
                                        </tr>
                                        
                                        <t t-set="subtotal_total" t-value="subtotal_total + line_subtotal" />
                                        <t t-set="discount_total" t-value="discount_total + line_discount" />
                                        <t t-set="cost_subtotal_total" t-value="cost_subtotal_total + line_cost_subtotal" />
                                        <t t-set="profit_total" t-value="profit_total + line_profit" />
                                    </t>
                                    
                                    <!-- Total row -->
                                    <tr class="fw-bold border-top">
                                        <td colspan="3"><strong>Total</strong></td>
                                        <td><strong t-esc="'%.2f' % subtotal_total" /></td>
                                        <td><strong t-esc="'%.2f' % discount_total" /></td>
                                        <td></td>
                                        <td><strong t-esc="'%.2f' % cost_subtotal_total" /></td>
                                        <td><strong t-esc="'%.2f' % profit_total" /></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </t>
        </t>
    </template>
</odoo>
